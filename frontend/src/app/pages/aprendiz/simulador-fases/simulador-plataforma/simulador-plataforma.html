<!-- DRAWER DE RECOMENDACIONES (Solo en modo aprendizaje) - DISEÑO MEJORADO -->
@if (esModoAprendizaje) {
<div class="drawer z-[60] drawer-end">
  <input id="drawer-recommendations" type="checkbox" class="drawer-toggle" />
  <div class="drawer-content"></div>
  <div class="drawer-side z-[60]">
    <label
      for="drawer-recommendations"
      aria-label="close sidebar"
      class="drawer-overlay bg-black/60 backdrop-blur-sm"
    ></label>
    <div class="menu min-h-full w-80 bg-white p-0 font-nunito dark:bg-gray-800">
      <!-- Header idéntico a desktop -->
      <div
        class="flex h-[60px] items-center justify-center border-b border-[#e8f4fc] bg-[#1788EF] dark:border-gray-700 dark:bg-[#1270c7]"
      >
        <div class="flex w-full items-center justify-between px-4">
          <div class="flex items-center gap-2">
            <span class="icon-[hugeicons--bulb] size-5 text-amber-300"></span>
            <h2 class="text-base font-bold text-white">Aprendizaje</h2>
          </div>
          <label
            for="drawer-recommendations"
            class="btn btn-circle text-white btn-ghost btn-sm hover:bg-white/20 dark:hover:bg-white/20"
          >
            ✕
          </label>
        </div>
      </div>
      <!-- Barra de acciones -->
      <div
        class="border-b border-[#e8f4fc] bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-900/50"
      >
        <div class="flex items-center justify-between gap-3">
          <button
            (click)="recomendacionActual && toggleAudio(recomendacionActual.recomendacionParaAsesor, 'rec')"
            [disabled]="!recomendacionActual"
            [class]="
              'btn min-w-0 flex-1 gap-2 rounded-lg border-0 text-white shadow-sm btn-sm transition-colors disabled:opacity-50 ' +
              (isPlaying('rec')
                ? 'bg-red-500 hover:bg-red-600'
                : 'bg-[#1788EF] hover:bg-[#1270c7]')
            "
            [attr.title]="isPlaying('rec') ? 'Detener' : 'Reproducir'"
          >
            <span
              [class]="isPlaying('rec') ? 'icon-[hugeicons--stop] size-4' : 'icon-[hugeicons--volume-high] size-4'"
            ></span>
            <span class="truncate">{{ isPlaying('rec') ? 'Detener' : 'Reproducir' }}</span>
          </button>

          <button
            (click)="abrirModalPoliticas()"
            class="btn min-w-0 flex-1 gap-2 rounded-lg border-0 bg-[#f59e0b] text-white shadow-sm transition-colors btn-sm hover:bg-[#d97706]"
            title="Ver políticas del banco"
          >
            <span class="icon-[hugeicons--bank] size-4"></span>
            <span class="truncate">Ver políticas</span>
          </button>
        </div>
      </div>

      <!-- Contenido de recomendaciones -->
      <div
        class="scrollbar-thin max-h-[calc(100vh-180px)] flex-1 space-y-4 overflow-y-auto bg-white p-4 scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:bg-gray-800 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
      >
        @if (recomendacionActual) {
        <div>
          <h3
            class="mb-2 flex items-center gap-2 text-xs font-bold text-[#034D82] sm:text-sm dark:text-white"
          >
            <span class="icon-[hugeicons--idea] size-3.5 text-[#1788EF] sm:size-4"></span>
            Recomendaciones IA
          </h3>
          <!-- Etapa actual debajo del título -->
          <div class="mb-3 flex items-center justify-center">
            <span
              class="inline-flex w-full max-w-full flex-col items-center gap-1 rounded-xl border border-[#e8f4fc] bg-white px-3 py-2 text-center sm:flex-row sm:gap-2 sm:rounded-full sm:px-4 sm:py-1.5 dark:border-gray-600 dark:bg-gray-800"
            >
              <span
                class="flex items-center gap-1.5 font-semibold text-[#034D82] sm:gap-2 dark:text-gray-200"
              >
                <span
                  class="icon-[hugeicons--flag-02] size-3.5 shrink-0 text-[#1788EF] sm:size-4 dark:text-[#60a5fa]"
                ></span>
                <span class="text-xs sm:text-sm">{{ nombreEtapaActual }}</span>
              </span>
              <span
                class="inline-flex shrink-0 items-center gap-1 rounded-lg bg-[#1788EF]/10 px-2 py-0.5 text-[10px] font-medium text-[#1788EF] sm:ml-1 sm:rounded-full sm:bg-[#1788EF]/10 sm:px-3 sm:py-1 sm:text-xs dark:bg-[#60a5fa]/20 dark:text-[#93c5fd] sm:dark:bg-[#60a5fa]/20"
                >Etapa {{ indiceEtapaActual }}</span
              >
            </span>
          </div>
          <div
            class="rounded-xl border border-[#e8f4fc] bg-[#1788EF]/5 p-3 sm:p-4 dark:border-gray-700 dark:bg-[#1788EF]/10"
          >
            <p
              class="text-hyphen text-xs leading-relaxed text-[#4a5d6f] sm:text-sm dark:text-gray-300"
            >
              {{ recomendacionActual.recomendacionParaAsesor }}
            </p>
          </div>
        </div>
        } @else {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <span
            class="mb-4 icon-[hugeicons--loading-03] size-12 animate-spin text-gray-300 sm:size-16 dark:text-gray-600"
          ></span>
          <p class="text-xs font-medium text-[#4a5d6f] sm:text-sm dark:text-gray-400">
            Esperando interacción...
          </p>
        </div>
        }
      </div>
    </div>
  </div>
</div>
}

<!-- DRAWER DE INFORMACIÓN DEL CLIENTE - DISEÑO MEJORADO -->
<div class="drawer z-[60] drawer-end">
  <input id="drawer-client-info" type="checkbox" class="drawer-toggle" />
  <div class="drawer-content"></div>
  <div class="drawer-side z-[60]">
    <label
      for="drawer-client-info"
      aria-label="close sidebar"
      class="drawer-overlay bg-black/60 backdrop-blur-sm"
    ></label>
    <div class="menu min-h-full w-80 bg-white p-0 font-nunito dark:bg-gray-800">
      <!-- Header idéntico a desktop -->
      <div
        class="flex h-[60px] items-center justify-center border-b border-[#e8f4fc] bg-[#00A448] dark:border-gray-700 dark:bg-[#008a3a]"
      >
        <div class="flex w-full items-center justify-between px-4">
          <div class="flex items-center gap-2">
            <span class="icon-[hugeicons--user-circle] size-5 text-white/90"></span>
            <h2 class="text-base font-bold text-white">Información del Cliente</h2>
          </div>
          <label
            for="drawer-client-info"
            class="btn btn-circle text-white btn-ghost btn-sm hover:bg-white/20 dark:hover:bg-white/20"
          >
            ✕
          </label>
        </div>
      </div>

      <!-- Contenido del cliente -->
      <div
        class="scrollbar-thin max-h-[calc(100vh-60px)] flex-1 space-y-4 overflow-y-auto bg-white p-4 scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:bg-gray-800 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
      >
        @if (infoCliente) {
        <!-- Avatar y datos básicos -->
        <div
          class="flex flex-col items-center rounded-xl border border-[#e8f4fc] bg-white p-4 text-center dark:border-gray-700 dark:bg-gray-900/50"
        >
          <div class="avatar mb-3">
            <div
              class="w-24 rounded-full shadow-lg ring-4 ring-[#00A448] ring-offset-2 ring-offset-white dark:ring-[#00A448]/80 dark:ring-offset-gray-800"
            >
              <img [src]="avatarCliente" [alt]="nombreCliente" />
            </div>
          </div>
          <h3 class="text-base font-bold text-[#034D82] sm:text-lg dark:text-white">
            {{ infoCliente.nombre }}
          </h3>
          <p class="text-xs font-medium text-[#4a5d6f] sm:text-sm dark:text-gray-400">
            {{ infoCliente.edad }} años
          </p>
          <span
            class="mt-2 rounded-full bg-[#f59e0b] px-3 py-1 text-[10px] font-bold text-white sm:text-xs"
          >
            {{ infoCliente.profesion }}
          </span>
        </div>

        <!-- Perfil del cliente -->
        <div
          class="space-y-3 rounded-xl border border-[#e8f4fc] bg-white p-4 dark:border-gray-700 dark:bg-gray-900/50"
        >
          <h3
            class="mb-3 flex items-center gap-2 text-xs font-bold text-[#034D82] sm:text-sm dark:text-white"
          >
            <span class="icon-[hugeicons--user] size-3.5 text-[#00A448] sm:size-4"></span>
            Perfil del Cliente
          </h3>

          <div class="space-y-2 text-xs sm:text-sm">
            <div class="flex items-start gap-2 rounded-lg p-2">
              <span
                class="mt-0.5 icon-[hugeicons--briefcase-01] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
              ></span>
              <div class="min-w-0">
                <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                  Situación
                </p>
                <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                  {{ infoCliente.situacion_actual }}
                </p>
              </div>
            </div>

            <div class="flex items-start gap-2 rounded-lg p-2">
              <span
                class="mt-0.5 icon-[hugeicons--target-01] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
              ></span>
              <div class="min-w-0">
                <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                  Motivación
                </p>
                <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                  {{ infoCliente.motivacion }}
                </p>
              </div>
            </div>

            <div class="flex items-start gap-2 rounded-lg p-2">
              <span
                class="mt-0.5 icon-[hugeicons--flag-02] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
              ></span>
              <div class="min-w-0">
                <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                  Objetivo
                </p>
                <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                  {{ infoCliente.objetivo }}
                </p>
              </div>
            </div>

            <div class="flex items-start gap-2 rounded-lg p-2">
              <span
                class="mt-0.5 icon-[hugeicons--chart-increase] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
              ></span>
              <div class="min-w-0">
                <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                  Riesgo
                </p>
                <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                  {{ infoCliente.perfil_riesgo }}
                </p>
              </div>
            </div>

            <div class="flex items-start gap-2 rounded-lg p-2">
              <span
                class="mt-0.5 icon-[hugeicons--book-02] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
              ></span>
              <div class="min-w-0">
                <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                  Conocimiento
                </p>
                <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                  {{ infoCliente.nivel_conocimiento }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Escenario -->
        <div
          class="rounded-xl border border-[#e8f4fc] bg-white p-4 dark:border-gray-700 dark:bg-gray-900/50"
        >
          <h3
            class="mb-3 flex items-center gap-2 text-xs font-bold text-[#034D82] sm:text-sm dark:text-white"
          >
            <span
              class="icon-[hugeicons--information-circle] size-3.5 text-[#00A448] sm:size-4"
            ></span>
            Escenario
          </h3>
          <p
            class="text-hyphen text-xs leading-relaxed text-[#4a5d6f] sm:text-sm dark:text-gray-300"
          >
            {{ infoCliente.escenario_narrativo }}
          </p>
        </div>
        }
      </div>
    </div>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<main
  class="simulador-container p-2 font-nunito max-[687px]:p-0 sm:p-4 dark:bg-gray-900 dark:text-gray-100"
>
  @if (error) {
  <div class="fade-in mb-2 alert alert-error shadow-lg dark:bg-red-900 dark:text-red-200">
    <span class="icon-[hugeicons--alert-circle] size-5"></span>
    <span>{{ error }}</span>
  </div>
  }

  <div class="simulador-grid">
    <!-- PANEL DE RECOMENDACIONES (Desktop - Solo en modo aprendizaje) -->
    @if (esModoAprendizaje) {
    <div
      class="simulador-panel hidden min-[1327px]:order-1 min-[1327px]:col-span-3 min-[1327px]:block"
    >
      <div
        class="card overflow-hidden rounded-xl border border-[#e8f4fc] bg-white shadow-lg dark:border-gray-700 dark:bg-gray-800"
      >
        <div
          class="flex h-[60px] items-center justify-center border-b border-[#e8f4fc] bg-[#1788EF] dark:border-gray-700 dark:bg-[#1270c7]"
        >
          <div class="flex items-center gap-2">
            <span class="icon-[hugeicons--bulb] size-5 text-amber-300"></span>
            <h2 class="card-title text-base font-bold text-white">Aprendizaje</h2>
          </div>
        </div>

        <!-- Barra de acciones -->
        <div
          class="border-b border-[#e8f4fc] bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-900/50"
        >
          <div class="flex items-center justify-between gap-3">
            <button
              (click)="recomendacionActual && toggleAudio(recomendacionActual.recomendacionParaAsesor, 'rec')"
              [disabled]="!recomendacionActual"
              [class]="
                'btn min-w-0 flex-1 gap-2 rounded-lg border-0 text-white shadow-sm btn-sm transition-colors disabled:opacity-50 ' +
                (isPlaying('rec')
                  ? 'bg-red-500 hover:bg-red-600'
                  : 'bg-[#1788EF] hover:bg-[#1270c7]')
              "
              [attr.title]="isPlaying('rec') ? 'Detener reproducción' : 'Reproducir consejos'"
            >
              <span
                [class]="isPlaying('rec') ? 'icon-[hugeicons--stop] size-4' : 'icon-[hugeicons--volume-high] size-4'"
              ></span>
              <span class="truncate">{{ isPlaying('rec') ? 'Detener' : 'Reproducir' }}</span>
            </button>

            <button
              (click)="abrirModalPoliticas()"
              class="btn min-w-0 flex-1 gap-2 rounded-lg border-0 bg-[#f59e0b] text-white shadow-sm transition-colors btn-sm hover:bg-[#d97706]"
              title="Ver políticas del banco"
            >
              <span class="icon-[hugeicons--bank] size-4"></span>
              <span class="truncate">Ver políticas</span>
            </button>
          </div>
        </div>
        <!-- Contenido de recomendaciones -->
        <div
          class="panel-content-scroll scrollbar-thin space-y-4 bg-white p-4 scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:bg-gray-800 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
        >
          @if (recomendacionActual) {
          <div>
            <h3
              class="mb-2 flex items-center gap-2 text-xs font-bold text-[#034D82] sm:text-sm dark:text-white"
            >
              <span class="icon-[hugeicons--idea] size-3.5 text-[#1788EF] sm:size-4"></span>
              Recomendaciones IA
            </h3>
            <!-- Etapa actual debajo del título -->
            <div class="mb-3 flex items-center justify-center">
              <span
                class="inline-flex flex-col items-center gap-1 rounded-xl border border-[#e8f4fc] bg-white px-3 py-2 text-center sm:flex-row sm:gap-2 sm:rounded-full sm:px-4 sm:py-1.5 dark:border-gray-600 dark:bg-gray-800"
              >
                <span
                  class="flex items-center gap-1.5 font-semibold text-[#034D82] sm:gap-2 dark:text-gray-200"
                >
                  <span
                    class="icon-[hugeicons--flag-02] size-3.5 text-[#1788EF] sm:size-4 dark:text-[#60a5fa]"
                  ></span>
                  <span class="text-xs sm:text-sm">{{ nombreEtapaActual }}</span>
                </span>
                <span
                  class="inline-flex shrink-0 items-center gap-1 rounded-lg bg-[#1788EF]/10 px-2 py-0.5 text-[10px] font-medium text-[#1788EF] sm:ml-1 sm:rounded-full sm:bg-[#1788EF]/10 sm:px-3 sm:py-1 sm:text-xs dark:bg-[#60a5fa]/20 dark:text-[#93c5fd] sm:dark:bg-[#60a5fa]/20"
                  >Etapa {{ indiceEtapaActual }}</span
                >
              </span>
            </div>
            <div
              class="rounded-xl border border-[#e8f4fc] bg-[#1788EF]/5 p-3 sm:p-4 dark:border-gray-700 dark:bg-[#1788EF]/10"
            >
              <p
                class="text-hyphen text-xs leading-relaxed text-[#4a5d6f] sm:text-sm dark:text-gray-300"
              >
                {{ recomendacionActual.recomendacionParaAsesor }}
              </p>
            </div>
          </div>
          } @else {
          <div class="flex flex-col items-center justify-center py-12 text-center">
            <span
              class="mb-4 icon-[hugeicons--loading-03] size-12 animate-spin text-gray-300 sm:size-16 dark:text-gray-600"
            ></span>
            <p class="text-xs font-medium text-[#4a5d6f] sm:text-sm dark:text-gray-400">
              Esperando interacción...
            </p>
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- PANEL DE CHAT -->
    <div
      class="simulador-panel min-[1327px]:order-2"
      [class]="esModoAprendizaje ? 'min-[1327px]:col-span-6' : 'min-[1327px]:col-span-9'"
    >
      <div
        class="card overflow-hidden rounded-xl border border-[#e8f4fc] bg-white shadow-lg max-[687px]:rounded-none max-[687px]:border-0 max-[687px]:shadow-none dark:border-gray-700 dark:bg-gray-800"
      >
        <div
          class="flex h-[60px] items-center border-b border-[#e8f4fc] bg-[#8b5cf6] px-3 dark:border-gray-700 dark:bg-[#7c3aed]"
        >
          <div class="flex w-full items-center justify-between">
            <div class="flex min-w-0 flex-1 items-center gap-2 sm:gap-3">
              <div class="avatar shrink-0">
                <div
                  class="w-8 rounded-full ring-2 ring-white/30 ring-offset-1 ring-offset-[#8b5cf6] sm:w-10 dark:ring-offset-[#7c3aed]"
                >
                  <img [src]="avatarCliente" [alt]="nombreCliente" />
                </div>
              </div>
              <div class="flex min-w-0 flex-1 items-center gap-2">
                <span
                  class="icon-[hugeicons--message-02] size-4 shrink-0 text-pink-200 sm:size-5 dark:text-pink-300"
                ></span>
                <h2
                  class="card-title hidden min-w-0 flex-1 truncate text-sm font-bold text-white sm:block sm:text-base"
                >
                  {{ nombreCliente }}
                </h2>
              </div>
            </div>

            <div class="flex gap-2">
              <!-- Botón de análisis (siempre visible, habilitado solo cuando hay datos) -->
              <button
                (click)="analisisDesempeno ? mostrarModalAnalisisDesempeno(datosFinalizacion) : mostrarModalResumen()"
                [disabled]="!modoSoloLectura || !datosFinalizacion"
                class="btn gap-2 rounded-lg border-0 bg-[#06b6d4] text-white shadow-sm transition-colors btn-sm hover:bg-[#0891b2] disabled:opacity-50 dark:bg-[#0891b2] dark:hover:bg-[#0e7490]"
                title="Ver análisis de desempeño"
              >
                <span class="icon-[hugeicons--audit-02] size-4"></span>
                <span class="hidden sm:inline">Análisis</span>
              </button>

              <!-- Botones de drawer para móvil (solo mostrar en móvil) -->
              <div class="flex gap-2 min-[1327px]:hidden">
                @if (esModoAprendizaje) {
                <label
                  for="drawer-recommendations"
                  class="btn gap-2 rounded-lg border-0 bg-[#1788EF] text-white shadow-sm transition-colors btn-sm hover:bg-[#1270c7] dark:bg-[#1270c7] dark:hover:bg-[#0d5ba8]"
                >
                  <span class="icon-[hugeicons--bulb] size-4"></span>
                  <span class="hidden sm:inline">Aprendizaje</span>
                </label>
                }
                <label
                  for="drawer-client-info"
                  class="btn gap-2 rounded-lg border-0 bg-[#00A448] text-white shadow-sm transition-colors btn-sm hover:bg-[#008a3a] dark:bg-[#008a3a] dark:hover:bg-[#006e2e]"
                >
                  <span class="icon-[hugeicons--user-circle] size-4"></span>
                  <span class="hidden sm:inline">Cliente</span>
                </label>
              </div>

              <!-- Menú desplegable personalizado -->
              <div class="relative" #menuContainer>
                <button
                  (click)="menuAbierto = !menuAbierto"
                  class="btn gap-2 rounded-xl border-0 bg-[#4a5d6f] text-white shadow-sm transition-colors btn-sm hover:bg-[#3d4f5f] dark:bg-gray-600 dark:hover:bg-gray-500"
                >
                  <span class="icon-[hugeicons--menu-01] size-4"></span>
                </button>

                <!-- Panel del menú -->
                @if (menuAbierto) {
                <!-- Backdrop invisible para cerrar -->
                <div class="fixed inset-0 z-[99]" (click)="menuAbierto = false"></div>
                <div
                  class="animate-fade-in absolute top-full right-0 z-100 mt-2 w-72 rounded-xl border border-[#e8f4fc] bg-white shadow-xl animate-duration-150 dark:border-gray-700 dark:bg-gray-800"
                >
                  <!-- Header del menú -->
                  <div
                    class="rounded-t-xl border-b border-[#e8f4fc] bg-[#034D82] px-4 py-3 dark:border-gray-700 dark:bg-[#1270c7]"
                  >
                    <div class="flex items-center gap-2">
                      <span class="icon-[hugeicons--settings-02] size-4 text-white/80"></span>
                      <span class="text-sm font-semibold text-white">Opciones de simulación</span>
                    </div>
                  </div>

                  <div class="space-y-2 p-3">
                    <!-- Tiempo transcurrido -->
                    <div
                      class="flex items-center justify-between rounded-xl bg-[#1788EF]/10 px-3 py-2.5 dark:bg-[#1788EF]/20"
                    >
                      <span
                        class="flex items-center gap-2.5 text-sm text-[#034D82] dark:text-gray-200"
                      >
                        <span class="icon-[hugeicons--clock-01] size-4 text-[#1788EF]"></span>
                        Tiempo
                      </span>
                      <span
                        class="tiempo-real rounded-lg bg-[#1788EF] px-2.5 py-1 text-xs font-bold text-white"
                        >{{ tiempoTranscurrido }}</span
                      >
                    </div>

                    <!-- Botón de sonido -->
                    <button
                      (click)="toggleSonido()"
                      class="flex w-full items-center justify-between rounded-xl px-3 py-2.5 transition-colors hover:bg-gray-100 dark:hover:bg-gray-700"
                    >
                      <span
                        class="flex items-center gap-2.5 text-sm text-[#4a5d6f] dark:text-gray-300"
                      >
                        <span
                          class="size-4"
                          [class]="sonidoHabilitado ? 'icon-[hugeicons--volume-high] text-[#00A448]' : 'icon-[hugeicons--volume-mute-02] text-gray-400'"
                        ></span>
                        {{ sonidoHabilitado ? 'Sonido activado' : 'Sonido silenciado' }}
                      </span>
                      <div
                        class="relative h-5 w-9 rounded-full transition-colors"
                        [class]="sonidoHabilitado ? 'bg-[#00A448]' : 'bg-gray-300 dark:bg-gray-600'"
                      >
                        <div
                          class="absolute top-0.5 h-4 w-4 rounded-full bg-white shadow transition-all"
                          [class]="sonidoHabilitado ? 'left-4' : 'left-0.5'"
                        ></div>
                      </div>
                    </button>

                    <!-- Botón de análisis (si está en modo solo lectura) -->
                    @if (modoSoloLectura && datosFinalizacion) {
                    <button
                      (click)="analisisDesempeno ? mostrarModalAnalisisDesempeno(datosFinalizacion) : mostrarModalResumen(); menuAbierto = false"
                      class="flex w-full items-center gap-2.5 rounded-xl px-3 py-2.5 text-sm text-[#4a5d6f] transition-colors hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700"
                    >
                      <span class="icon-[hugeicons--audit-02] size-4 text-[#8b5cf6]"></span>
                      Ver Análisis
                    </button>
                    }

                    <!-- Divider -->
                    <hr class="border-[#e8f4fc] dark:border-gray-700" />

                    <!-- Modo de simulación -->
                    <div
                      class="flex items-center justify-between rounded-xl bg-gray-50 px-3 py-2.5 dark:bg-gray-900/50"
                    >
                      <span
                        class="flex items-center gap-2.5 text-sm text-[#4a5d6f] dark:text-gray-300"
                      >
                        <span
                          class="size-4"
                          [class]="esModoAprendizaje ? 'icon-[hugeicons--book-02] text-[#1788EF]' : 'icon-[hugeicons--tick-02] text-[#00A448]'"
                        ></span>
                        Modo
                      </span>
                      <span
                        class="rounded-lg px-2.5 py-1 text-xs font-semibold text-white"
                        [class]="esModoAprendizaje ? 'bg-[#1788EF]' : 'bg-[#00A448]'"
                      >
                        {{ esModoAprendizaje ? 'Aprendizaje' : 'Evaluación' }}
                      </span>
                    </div>

                    <!-- Estado de sincronización -->
                    <div
                      class="flex items-center justify-between rounded-xl bg-gray-50 px-3 py-2.5 dark:bg-gray-900/50"
                    >
                      <span
                        class="flex items-center gap-2.5 text-sm text-[#4a5d6f] dark:text-gray-300"
                      >
                        <span class="size-4 text-[#00A448] icon-[hugeicons--wifi]"></span>
                        Estado
                      </span>
                      <span
                        class="flex items-center gap-1.5 rounded-lg bg-[#00A448]/10 px-2.5 py-1 text-xs font-semibold text-[#00A448] dark:bg-[#00A448]/20"
                      >
                        <span class="size-1.5 animate-pulse rounded-full bg-[#00A448]"></span>
                        En línea
                      </span>
                    </div>

                    <!-- Divider antes de finalizar -->
                    <hr class="border-[#e8f4fc] dark:border-gray-700" />

                    <!-- Botón de finalizar -->
                    <button
                      (click)="confirmarFinalizacion(); menuAbierto = false"
                      [disabled]="finalizandoSimulacion"
                      class="flex w-full items-center justify-center gap-2.5 rounded-xl border border-red-200 bg-red-50 px-3 py-2.5 text-sm font-medium text-red-600 transition-colors hover:bg-red-100 disabled:opacity-50 dark:border-red-900/50 dark:bg-red-900/20 dark:text-red-400 dark:hover:bg-red-900/30"
                    >
                      <span class="icon-[hugeicons--stop] size-4"></span>
                      {{ finalizandoSimulacion ? 'Finalizando...' : 'Finalizar simulación' }}
                    </button>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
        </div>

        <!-- Mensajes -->
        <div
          #chatContainer
          (scroll)="onChatScroll()"
          class="panel-content-scroll scrollbar-thin space-y-4 scroll-smooth bg-white p-4 scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:bg-gray-800 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
        >
          <!-- Mostrar marcador de la etapa actual aunque no haya mensajes aún -->
          @if (indicesEtapas.length === 0 && etapaActual) {
          <div class="etapa-marker fade-in relative my-4 flex items-center justify-center sm:my-6">
            <span
              class="relative z-10 inline-flex flex-col items-center gap-1 rounded-xl border border-[#e8f4fc] bg-white px-3 py-2 text-center sm:flex-row sm:gap-2 sm:rounded-full sm:px-4 sm:py-1.5 dark:border-gray-600 dark:bg-gray-800"
            >
              <span
                class="flex items-center gap-1.5 truncate font-semibold text-[#034D82] sm:gap-2 dark:text-gray-200"
              >
                <span
                  class="icon-[hugeicons--flag-02] size-3.5 text-[#1788EF] sm:size-4 dark:text-[#60a5fa]"
                ></span>
                <span class="truncate text-xs sm:text-sm">{{ nombreEtapaActual }}</span>
              </span>
              <span
                class="inline-flex shrink-0 items-center gap-1 rounded-lg bg-[#1788EF]/10 px-2 py-0.5 text-[10px] font-medium text-[#1788EF] sm:ml-1 sm:rounded-full sm:bg-[#1788EF]/10 sm:px-3 sm:py-1 sm:text-xs dark:bg-[#60a5fa]/20 dark:text-[#93c5fd] sm:dark:bg-[#60a5fa]/20"
                >Etapa {{ indiceEtapaActual }}</span
              >
            </span>
          </div>
          } @for (indiceEtapa of indicesEtapas; track indiceEtapa) { @let mensajesEtapa =
          mensajesPorEtapa[indiceEtapa]; @let primerMensaje = mensajesEtapa[0];

          <!-- Marcador de etapa -->
          <div class="etapa-marker fade-in relative my-4 flex items-center justify-center sm:my-6">
            <span
              class="relative z-10 inline-flex flex-col items-center gap-1 rounded-xl border border-[#e8f4fc] bg-white px-3 py-2 text-center sm:flex-row sm:gap-2 sm:rounded-full sm:px-4 sm:py-1.5 dark:border-gray-600 dark:bg-gray-800"
            >
              <span
                class="flex items-center gap-1.5 truncate font-semibold text-[#034D82] sm:gap-2 dark:text-gray-200"
              >
                <span
                  class="icon-[hugeicons--flag-02] size-3.5 text-[#1788EF] sm:size-4 dark:text-[#60a5fa]"
                ></span>
                <span class="truncate text-xs sm:text-sm"
                  >{{ (mensajesEtapa && mensajesEtapa.length) ? primerMensaje.nombreEtapa :
                  (etapaActual?.nombre || 'Etapa') }}</span
                >
              </span>
              <span
                class="inline-flex shrink-0 items-center gap-1 rounded-lg bg-[#1788EF]/10 px-2 py-0.5 text-[10px] font-medium text-[#1788EF] sm:ml-1 sm:rounded-full sm:bg-[#1788EF]/10 sm:px-3 sm:py-1 sm:text-xs dark:bg-[#60a5fa]/20 dark:text-[#93c5fd] sm:dark:bg-[#60a5fa]/20"
                >Etapa {{ indiceEtapa }}</span
              >
            </span>
          </div>

          @for (mensaje of mensajesEtapa; track $index) { @if (mensaje.receptor === 'Asesor') {
          <!-- Mensaje del Cliente -->
          <div class="fade-in relative chat-start chat">
            <div class="avatar chat-image mt-[22px] self-start">
              <div
                class="mt-0 w-8 rounded-full ring ring-emerald-500 ring-offset-2 ring-offset-base-100 sm:w-10 dark:ring-emerald-600"
              >
                <img [src]="avatarCliente" [alt]="nombreCliente" />
              </div>
            </div>

            <div
              class="chat-header mb-1 flex items-center gap-2 text-xs text-[#4a5d6f] sm:text-sm dark:text-gray-300"
            >
              <button
                (click)="toggleAudio(mensaje.mensaje, 'msg-' + indiceEtapa + '-' + $index)"
                class="btn h-auto min-h-0 p-0 btn-xs"
                [ngClass]="isPlaying('msg-' + indiceEtapa + '-' + $index) ? 'bg-red-500 text-white rounded-full px-1' : 'btn-ghost'"
                [title]="isPlaying('msg-' + indiceEtapa + '-' + $index) ? 'Detener' : 'Reproducir'"
              >
                <span
                  [class]="isPlaying('msg-' + indiceEtapa + '-' + $index)
                    ? 'icon-[hugeicons--stop] size-3.5 text-white sm:size-4'
                    : 'icon-[hugeicons--volume-high] size-3.5 text-emerald-500 hover:text-emerald-600 sm:size-4 dark:text-emerald-400 dark:hover:text-emerald-300'"
                ></span>
              </button>
              <span>Cliente</span>
            </div>

            <div class="relative max-w-[85%]">
              <div
                class="absolute top-4 -left-[6px] z-0 h-3 w-3 rotate-45 border border-emerald-100 bg-emerald-50 dark:border-emerald-700 dark:bg-emerald-900/40"
              ></div>
              <div
                class="relative z-10 rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-emerald-900 sm:px-4 dark:border-emerald-800 dark:bg-emerald-950 dark:text-emerald-100"
              >
                <span class="text-hyphen relative z-10 text-xs sm:text-sm"
                  >{{ mensaje.mensaje }}</span
                >
              </div>
            </div>
          </div>
          } @else {
          <!-- Mensaje del Asesor -->
          <div class="fade-in relative chat-end chat">
            <div class="avatar chat-image mt-[22px] self-start">
              <div
                class="mt-0 w-8 rounded-full ring ring-blue-500 ring-offset-2 ring-offset-base-100 sm:w-10 dark:ring-blue-600"
              >
                <img [src]="avatarAsesor" alt="Asesor" />
              </div>
            </div>

            <div
              class="chat-header mb-1 flex items-center gap-2 text-xs text-[#4a5d6f] sm:text-sm dark:text-gray-300"
            >
              <span>Asesor</span>
            </div>

            <div class="relative max-w-[85%]">
              <div
                class="absolute top-4 -right-[6px] z-0 h-3 w-3 rotate-45 border border-blue-100 bg-blue-50 dark:border-blue-700 dark:bg-blue-900/40"
              ></div>
              <div
                class="relative z-10 rounded-2xl border border-blue-200 bg-blue-50 px-3 py-2 text-blue-900 sm:px-4 dark:border-blue-800 dark:bg-blue-950 dark:text-blue-100"
              >
                <span class="text-hyphen relative z-10 text-xs sm:text-sm"
                  >{{ mensaje.mensaje }}</span
                >
              </div>
            </div>
          </div>
          } } }

          <!-- NOTA: los mensajes de sistema (alertas/info) ya no se muestran dentro del flujo de chat
               según configuración solicitada. Se mantienen en memoria para otros usos (toasts/header).
          -->

          <!-- Indicador de escritura: mostrar avatar/label según quien esté escribiendo -->
          @if (indicadorEmisor) {
          <div class="fade-in relative chat-start chat">
            <div class="avatar chat-image mt-[22px] self-start">
              <div
                class="mt-0 w-8 rounded-full ring ring-emerald-500 ring-offset-2 ring-offset-base-100 sm:w-10 dark:ring-emerald-600"
              >
                <img
                  [src]="indicadorEmisor === 'Cliente' ? avatarCliente : avatarAsesor"
                  [alt]="indicadorEmisor === 'Cliente' ? nombreCliente : nombreAsesor"
                />
              </div>
            </div>

            <div
              class="chat-header mb-1 flex items-center gap-2 text-xs text-[#4a5d6f] sm:text-sm dark:text-gray-300"
            >
              <span>{{ indicadorEmisor }}</span>
            </div>

            <div class="relative max-w-[85%]">
              <div
                class="absolute top-4 -left-[6px] z-0 h-3 w-3 rotate-45 border border-emerald-100 bg-emerald-50 dark:border-emerald-700 dark:bg-emerald-900/40"
              ></div>
              <div
                class="relative z-10 rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-4 text-emerald-900 sm:px-5 dark:border-emerald-800 dark:bg-emerald-950 dark:text-emerald-100"
              >
                <div class="flex gap-1">
                  <div class="typing-indicator"></div>
                  <div class="typing-indicator"></div>
                  <div class="typing-indicator"></div>
                </div>
              </div>
            </div>
          </div>
          }
        </div>

        <!-- Input de mensaje -->
        <div
          class="flex shrink-0 flex-col gap-3 border-t border-[#e8f4fc] bg-gray-50 p-3 sm:p-4 dark:border-gray-700 dark:bg-gray-900/50"
        >
          <!-- Barra superior con indicaciones y etapa -->
          <div class="flex w-full items-center gap-2">
            <details #etapa class="relative">
              <summary
                class="btn cursor-pointer gap-2 rounded-xl border-0 bg-[#034D82] text-white shadow-sm transition-colors btn-sm select-none hover:bg-[#023a5e] sm:btn-md dark:bg-[#1788EF] dark:hover:bg-[#1270c7]"
              >
                <span class="icon-[hugeicons--information-circle] size-4"></span>
                <span class="hidden sm:inline">Indicaciones</span>
              </summary>

              <div
                class="card absolute bottom-full left-0 z-20 mb-2 w-64 rounded-xl border border-[#e8f4fc] bg-white p-4 shadow-xl sm:w-72 dark:border-gray-700 dark:bg-gray-800"
              >
                <h3 class="mb-2 text-base font-bold text-[#034D82] dark:text-white">
                  Objetivo de la etapa
                </h3>
                <div class="text-sm text-[#4a5d6f] dark:text-gray-300">
                  {{ objetivoEtapaActual }}
                </div>
                <button
                  class="btn mt-3 w-full rounded-xl border-0 bg-[#1788EF] text-white transition-colors btn-sm hover:bg-[#1270c7]"
                  (click)="cerrarIndicaciones()"
                >
                  Entendido
                </button>
              </div>
            </details>

            <div class="flex flex-1 items-center justify-center">
              <span
                class="inline-flex w-full flex-wrap items-center justify-center gap-2 rounded-full border border-[#e8f4fc] bg-white px-4 py-1.5 text-center dark:border-gray-600 dark:bg-gray-800"
              >
                <span
                  class="flex items-center gap-2 font-semibold text-[#034D82] dark:text-gray-200"
                >
                  <span
                    class="icon-[hugeicons--flag-02] size-3.5 shrink-0 text-[#1788EF] sm:size-4 dark:text-[#60a5fa]"
                  ></span>
                  <span class="text-xs sm:text-sm">{{ nombreEtapaActual }}</span>
                </span>
                <span
                  class="hidden shrink-0 items-center gap-1 rounded-full bg-[#1788EF]/10 px-3 py-1 text-[10px] font-medium text-[#1788EF] min-[420px]:inline-flex sm:text-xs dark:bg-[#60a5fa]/20 dark:text-[#93c5fd]"
                  >Etapa {{ indiceEtapaActual }}</span
                >
              </span>
            </div>
          </div>

          <!-- Área de escritura y botones -->
          <div class="flex gap-3">
            <textarea
              #mensajeTextarea
              [(ngModel)]="mensajeAsesor"
              (input)="onTextareaInput($event)"
              (click)="onTextareaCaretChange($event)"
              (keyup)="onTextareaCaretChange($event)"
              (keydown)="onTextareaKeyDown($event)"
              [disabled]="modoSoloLectura || enviandoMensaje || finalizandoSimulacion"
              placeholder="Escribe tu mensaje al cliente..."
              class="textarea h-16 flex-1 resize-none rounded-xl border border-[#e8f4fc] bg-white text-[#034D82] placeholder-[#4a5d6f]/60 transition-colors focus:border-[#8b5cf6] focus:ring-2 focus:ring-[#8b5cf6]/20 focus:outline-none disabled:opacity-50 sm:h-20 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-100 dark:placeholder-gray-400 dark:focus:border-[#8b5cf6]"
            ></textarea>

            <!-- Columna de botones -->
            <div class="flex flex-col gap-2">
              <button
                (click)="enviarMensaje()"
                [disabled]="modoSoloLectura || !mensajeAsesor.trim() || enviandoMensaje || finalizandoSimulacion"
                class="btn h-auto min-h-0 flex-1 gap-2 rounded-xl border-0 bg-[#8b5cf6] px-4 py-2 text-white shadow-sm transition-colors hover:bg-[#7c3aed] disabled:opacity-50"
              >
                @if (enviandoMensaje) {
                <span class="loading loading-sm loading-spinner"></span>
                } @else {
                <span class="icon-[hugeicons--sent] size-4"></span>
                }
                <span class="hidden sm:inline"
                  >{{ enviandoMensaje ? 'Enviando...' : 'Enviar' }}</span
                >
              </button>
              <button
                (click)="toggleDictado()"
                [disabled]="modoSoloLectura || enviandoMensaje || finalizandoSimulacion"
                class="btn h-auto min-h-0 flex-1 gap-2 rounded-xl border-0 px-4 py-2 shadow-sm transition-colors disabled:opacity-50"
                [ngClass]="grabandoVoz ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-[#06b6d4] hover:bg-[#0891b2] text-white'"
                title="Dictar mensaje por voz"
              >
                <span
                  class="icon-[hugeicons--mic-01] inline-block size-4 transition-transform duration-100 ease-in-out"
                  [class.pulse-mic]="grabandoVoz"
                ></span>
                <span class="hidden sm:inline">{{ grabandoVoz ? 'Grabando...' : 'Dictar' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL DE INFORMACIÓN DEL CLIENTE (Desktop) -->
    <div
      class="simulador-panel hidden min-[1327px]:order-3 min-[1327px]:col-span-3 min-[1327px]:block"
    >
      <div
        class="card overflow-hidden rounded-xl border border-[#e8f4fc] bg-white shadow-lg dark:border-gray-700 dark:bg-gray-800"
      >
        <div
          class="flex h-[60px] items-center justify-center border-b border-[#e8f4fc] bg-[#00A448] dark:border-gray-700 dark:bg-[#008a3a]"
        >
          <div class="flex items-center gap-2">
            <span class="icon-[hugeicons--user-circle] size-5 text-white/90"></span>
            <h2 class="card-title text-base font-bold text-white">Información del Cliente</h2>
          </div>
        </div>

        <div
          class="panel-content-scroll scrollbar-thin space-y-4 bg-white p-4 scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:bg-gray-800 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
        >
          @if (infoCliente) {
          <div
            class="flex flex-col items-center rounded-xl border border-[#e8f4fc] bg-white p-4 text-center dark:border-gray-700 dark:bg-gray-900/50"
          >
            <div class="avatar mb-3">
              <div
                class="w-24 rounded-full shadow-lg ring-4 ring-[#00A448] ring-offset-2 ring-offset-white dark:ring-[#00A448]/80 dark:ring-offset-gray-800"
              >
                <img [src]="avatarCliente" [alt]="nombreCliente" />
              </div>
            </div>
            <h3 class="text-base font-bold text-[#034D82] sm:text-lg dark:text-white">
              {{ infoCliente.nombre }}
            </h3>
            <p class="text-xs font-medium text-[#4a5d6f] sm:text-sm dark:text-gray-400">
              {{ infoCliente.edad }} años
            </p>
            <span
              class="mt-2 rounded-full bg-[#f59e0b] px-3 py-1 text-[10px] font-bold text-white sm:text-xs"
            >
              {{ infoCliente.profesion }}
            </span>
          </div>

          <div
            class="space-y-3 rounded-xl border border-[#e8f4fc] bg-white p-4 dark:border-gray-700 dark:bg-gray-900/50"
          >
            <h3
              class="mb-3 flex items-center gap-2 text-xs font-bold text-[#034D82] sm:text-sm dark:text-white"
            >
              <span class="icon-[hugeicons--user] size-3.5 text-[#00A448] sm:size-4"></span>
              Perfil del Cliente
            </h3>

            <div class="space-y-2 text-xs sm:text-sm">
              <div class="flex items-start gap-2 rounded-lg p-2">
                <span
                  class="mt-0.5 icon-[hugeicons--briefcase-01] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
                ></span>
                <div class="min-w-0">
                  <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                    Situación
                  </p>
                  <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                    {{ infoCliente.situacion_actual }}
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-2 rounded-lg p-2">
                <span
                  class="mt-0.5 icon-[hugeicons--target-01] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
                ></span>
                <div class="min-w-0">
                  <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                    Motivación
                  </p>
                  <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                    {{ infoCliente.motivacion }}
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-2 rounded-lg p-2">
                <span
                  class="mt-0.5 icon-[hugeicons--flag-02] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
                ></span>
                <div class="min-w-0">
                  <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                    Objetivo
                  </p>
                  <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                    {{ infoCliente.objetivo }}
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-2 rounded-lg p-2">
                <span
                  class="mt-0.5 icon-[hugeicons--chart-increase] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
                ></span>
                <div class="min-w-0">
                  <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                    Riesgo
                  </p>
                  <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                    {{ infoCliente.perfil_riesgo }}
                  </p>
                </div>
              </div>

              <div class="flex items-start gap-2 rounded-lg p-2">
                <span
                  class="mt-0.5 icon-[hugeicons--book-02] size-3.5 shrink-0 text-[#4a5d6f] sm:size-4 dark:text-gray-400"
                ></span>
                <div class="min-w-0">
                  <p class="text-[10px] font-semibold text-[#4a5d6f] sm:text-xs dark:text-gray-400">
                    Conocimiento
                  </p>
                  <p class="text-hyphen text-[#034D82] dark:text-gray-200">
                    {{ infoCliente.nivel_conocimiento }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div
            class="rounded-xl border border-[#e8f4fc] bg-white p-4 dark:border-gray-700 dark:bg-gray-900/50"
          >
            <h3
              class="mb-3 flex items-center gap-2 text-xs font-bold text-[#034D82] sm:text-sm dark:text-white"
            >
              <span
                class="icon-[hugeicons--information-circle] size-3.5 text-[#00A448] sm:size-4"
              ></span>
              Escenario
            </h3>
            <p
              class="text-hyphen text-xs leading-relaxed text-[#4a5d6f] sm:text-sm dark:text-gray-300"
            >
              {{ infoCliente.escenario_narrativo }}
            </p>
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</main>

<!-- MODAL DE POLÍTICAS DEL BANCO -->
<dialog #modalPoliticas class="modal">
  <div
    class="modal-box max-w-2xl border border-[#e8f4fc] bg-white shadow-2xl dark:border-gray-700 dark:bg-gray-800"
  >
    <form method="dialog">
      <button
        class="btn absolute top-3 right-3 btn-circle text-[#4a5d6f] btn-sm hover:bg-gray-100 hover:text-[#034D82] dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
      >
        ✕
      </button>
    </form>

    <div
      class="-mx-6 -mt-6 mb-6 border-b border-[#e8f4fc] bg-[#034D82] p-6 dark:border-gray-700 dark:bg-[#1788EF]"
    >
      <h3 class="flex items-center gap-3 text-xl font-bold text-white">
        <span class="icon-[hugeicons--bank] size-6 text-white/80"></span>
        Políticas del Banco
      </h3>
      <p class="mt-2 text-sm font-medium text-white/80">
        Normativas y procedimientos institucionales
      </p>
    </div>

    <div
      class="scrollbar-thin max-h-96 space-y-4 overflow-y-auto pr-2 scrollbar-thumb-gray-300 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:scrollbar-thumb-gray-600 dark:hover:scrollbar-thumb-gray-500"
    >
      <app-politicas-plataforma></app-politicas-plataforma>
    </div>

    <div class="modal-action mt-6">
      <button
        (click)="cerrarModalPoliticas()"
        class="btn gap-2 rounded-lg border-0 bg-[#034D82] px-6 text-white shadow-sm transition-colors btn-sm hover:bg-[#023a5e] dark:bg-[#1788EF] dark:hover:bg-[#1270c7]"
      >
        <span class="icon-[hugeicons--tick-02] size-4"></span>
        Entendido
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/60 backdrop-blur-sm">
    <button>close</button>
  </form>
</dialog>

<!-- MODAL DE FINALIZAR -->
<dialog #modalFinalizar class="modal">
  <div class="modal-box border border-[#e8f4fc] bg-white dark:border-gray-700 dark:bg-gray-800">
    <h3 class="text-lg font-bold text-[#034D82] dark:text-white">Finalizar simulación</h3>
    <p class="py-4 text-[#4a5d6f] dark:text-gray-300">
      ¿Estás seguro de que deseas finalizar la simulación? Se perderá el progreso actual.
    </p>
    <div class="modal-action">
      <button
        (click)="cerrarModalFinalizar()"
        class="btn border-[#e8f4fc] bg-white text-[#4a5d6f] hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
      >
        Cancelar
      </button>
      <button
        (click)="finalizarSimulacion()"
        class="btn ml-2 border-0 bg-red-500 text-white hover:bg-red-600"
      >
        Finalizar
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50">
    <button>close</button>
  </form>
</dialog>

<!-- MODAL DE ANÁLISIS DE DESEMPEÑO -->
<dialog #modalAnalisis class="modal">
  <div
    class="modal-box max-w-3xl border border-[#e8f4fc] bg-white dark:border-gray-700 dark:bg-gray-800"
  >
    <!-- Botón de cerrar (X) -->
    <button
      type="button"
      (click)="volverAVerSimulacion()"
      class="btn absolute top-3 right-3 btn-circle text-[#4a5d6f] btn-ghost btn-sm hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700"
    >
      ✕
    </button>

    <!-- Título -->
    <h3 class="mb-4 text-lg font-bold text-[#034D82] dark:text-white">
      <span class="mr-2 icon-[hugeicons--audit-02] inline-block size-6 text-[#8b5cf6]"></span>
      Análisis de Desempeño
    </h3>

    <!-- Contenido del análisis -->
    @if (analisisDesempeno) {
    <!-- Puntuación General -->
    <div
      class="card mb-4 border-2"
      [class]="configAnalisis.bgClass + ' border-' + configAnalisis.color"
    >
      <div class="card-body">
        <div class="flex items-center justify-between">
          <h4 class="card-title text-lg text-[#034D82] dark:text-white">Puntuación General</h4>
          <div class="text-4xl">{{ configAnalisis.emoji }}</div>
        </div>
        <div class="badge badge-lg" [class]="'badge-' + configAnalisis.color">
          {{ analisisDesempeno.puntuacion_cualitativa }}
        </div>
      </div>
    </div>

    <!-- Resumen General -->
    <div
      class="card mb-4 border border-[#e8f4fc] bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50"
    >
      <div class="card-body">
        <h4 class="card-title text-lg text-[#034D82] dark:text-white">
          <span class="icon-[hugeicons--file-search] size-5 text-[#1788EF]"></span>
          Resumen del Desempeño
        </h4>
        <p class="text-sm leading-relaxed text-[#4a5d6f] dark:text-gray-300">
          {{ analisisDesempeno.resumen_general }}
        </p>
      </div>
    </div>
    } @else {
    <!-- Mensaje cuando no hay análisis de desempeño -->
    <div
      class="card mb-4 border border-[#e8f4fc] bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50"
    >
      <div class="card-body">
        <p class="text-center text-sm text-[#4a5d6f] dark:text-gray-300">
          La simulación ha finalizado. Revisa las estadísticas a continuación.
        </p>
      </div>
    </div>
    }

    <!-- Estadísticas -->
    @if (datosFinalizacion) {
    <div class="mb-4 grid grid-cols-2 gap-4">
      <div
        class="stat rounded-xl border border-[#e8f4fc] bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50"
      >
        <div class="stat-title text-[#4a5d6f] dark:text-gray-400">Duración</div>
        <div class="stat-value text-2xl text-[#034D82] dark:text-white">
          {{ datosFinalizacion.duracion_formato || datosFinalizacion.simulacion?.duracion_formato ||
          'N/A' }}
        </div>
        <div class="stat-desc text-[#4a5d6f]/70 dark:text-gray-500">
          {{ datosFinalizacion.duracion_segundos || datosFinalizacion.simulacion?.duracion_segundos
          || 0 }} segundos
        </div>
      </div>
      <div
        class="stat rounded-xl border border-[#e8f4fc] bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50"
      >
        <div class="stat-title text-[#4a5d6f] dark:text-gray-400">Etapas</div>
        <div class="stat-value text-2xl text-[#034D82] dark:text-white">
          {{ datosFinalizacion.etapas_completadas ||
          datosFinalizacion.simulacion?.etapas_completadas || indiceEtapaActual }}/{{ totalEtapas ||
          datosFinalizacion.simulacion?.total_etapas }}
        </div>
        <div class="stat-desc text-[#4a5d6f]/70 dark:text-gray-500">Completadas</div>
      </div>
    </div>

    @if (datosFinalizacion.motivo_finalizacion === 'salida_contexto') {
    <div
      class="mb-4 flex items-center gap-2 rounded-lg border border-amber-200 bg-amber-50 p-3 text-amber-800 dark:border-amber-800 dark:bg-amber-900/30 dark:text-amber-200"
    >
      <span class="icon-[hugeicons--alert-circle] size-5"></span>
      <span class="text-sm">Simulación terminada por salida de contexto</span>
    </div>
    } }

    <!-- Botones de acción -->
    <div class="modal-action flex gap-2">
      <button
        type="button"
        (click)="volverAVerSimulacion()"
        class="btn flex-1 border-[#e8f4fc] bg-white text-[#4a5d6f] hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
      >
        <span class="icon-[hugeicons--eye] size-4"></span>
        Volver (solo lectura)
      </button>
      <button
        type="button"
        (click)="iniciarNuevaSimulacion()"
        class="btn flex-1 border-0 bg-[#00A448] text-white hover:bg-[#008a3a]"
      >
        <span class="icon-[hugeicons--refresh] size-4"></span>
        Finalizar y volver a configurar
      </button>
    </div>
  </div>

  <!-- Backdrop del modal -->
  <form method="dialog" class="modal-backdrop bg-black/50">
    <button type="button" (click)="salirDeSimulacion()">close</button>
  </form>
</dialog>
